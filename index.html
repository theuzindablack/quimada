<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Among Us Ultra Edition</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --red: #ff3f34; --green: #05c46b; --blue: #1e90ff; }
        body, html { margin:0; padding:0; overflow:hidden; background:#000; font-family: 'Courier New', Courier, monospace; color: white; touch-action: none; }
        canvas { display:block; }
        
        /* UI Screens */
        .screen { position:absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:100; background: rgba(0,0,0,0.9); }
        #lobby { background: radial-gradient(circle, #2c3e50 0%, #000 100%); }
        
        /* Forms */
        input { padding: 12px; margin: 10px; border-radius: 5px; border: none; width: 250px; background: #222; color: #fff; text-align: center; font-size: 1.2rem; }
        button { padding: 12px 24px; margin: 5px; cursor: pointer; border-radius: 5px; border: none; font-weight: bold; text-transform: uppercase; transition: 0.3s; }
        .btn-start { background: var(--green); color: white; }
        .btn-kick { background: var(--red); font-size: 10px; padding: 5px; }
        
        /* Game UI */
        #game-ui { position:absolute; top:10px; left:10px; z-index:50; pointer-events: none; }
        #controls { position:absolute; bottom:20px; right:20px; display:flex; gap:10px; z-index:60; }
        .action-btn { width: 80px; height: 80px; border-radius: 50%; background: rgba(255,255,255,0.2); border: 4px solid white; color: white; font-weight: bold; pointer-events: auto; }
        
        #joystick { position:absolute; bottom:50px; left:50px; width:120px; height:120px; background:rgba(255,255,255,0.1); border: 2px solid white; border-radius:50%; z-index:10; }
        #stick { position:absolute; left:40px; top:40px; width:40px; height:40px; background:white; border-radius:50%; }

        /* Cosmetics Menu */
        #cosmetics { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin: 10px; }
        .hat-opt { background: #333; padding: 5px; cursor: pointer; border: 1px solid #555; font-size: 12px; }

        #voting-screen { display:none; background: rgba(0,0,0,0.85); flex-direction: column; padding: 20px; border: 2px solid white; }
    </style>
</head>
<body>

<div id="setup" class="screen">
    <h1 style="color:var(--red); font-size: 3rem;">AMONG US CLONE</h1>
    <input type="text" id="nameIn" placeholder="NOME" value="Tripulante">
    <input type="text" id="roomIn" placeholder="ID DA SALA" value="SPACE77">
    <div>
        <button onclick="init(true)" style="background:var(--green)">CRIAR SALA</button>
        <button onclick="init(false)" style="background:var(--blue)">ENTRAR</button>
    </div>
</div>

<div id="lobby" class="screen" style="display:none;">
    <h2 id="lobby-status">LOBBY</h2>
    <div id="player-list" style="margin: 20px; text-align: left; min-width: 200px;"></div>
    
    <div id="cosmetics">
        <div class="hat-opt" onclick="setHat('none')">Sem Chap√©u</div>
        <div class="hat-opt" onclick="setHat('banana')">üçå Banana</div>
        <div class="hat-opt" onclick="setHat('pirate')">üè¥‚Äç‚ò†Ô∏è Pirata</div>
        <div class="hat-opt" onclick="setHat('phone')">üì± Celular</div>
        <div class="hat-opt" onclick="setHat('headphone')">üéß Fone</div>
        <div class="hat-opt" onclick="setHat('mask_black')">üò∑ M√°scara P</div>
        <div class="hat-opt" onclick="setHat('mask_covid')">ü¶† COVID</div>
    </div>

    <div id="host-controls" style="display:none;">
        <button onclick="startGame()" class="btn-start">INICIAR PARTIDA</button>
        <button onclick="closeRoom()" style="background: #333;">FECHAR SALA</button>
    </div>
    <div id="countdown" style="font-size: 2rem; color: yellow;"></div>
</div>

<div id="voting-screen" class="screen">
    <h2>QUEM √â O IMPOSTOR?</h2>
    <div id="vote-list"></div>
    <button onclick="skipVote()" style="background:gray">SKIP VOTE</button>
</div>

<div id="game-ui" style="display:none;">
    <div id="role-display" style="font-size: 24px; font-weight: bold;"></div>
    <div id="tasks-display"></div>
</div>

<div id="controls" style="display:none;">
    <button id="kill-btn" class="action-btn" style="background:var(--red); display:none;" onclick="doAction('kill')">KILL</button>
    <button id="use-btn" class="action-btn" style="background:var(--blue);" onclick="doAction('use')">USE</button>
    <button id="report-btn" class="action-btn" style="background:orange;" onclick="doAction('report')">REPORT</button>
</div>

<canvas id="game"></canvas>
<div id="joystick" style="display:none;"><div id="stick"></div></div>

<script>
/** * L√ìGICA DO JOGO 
 */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
let peer, myId, roomName, isHost = false;
let players = {};
let conns = [];
let gameState = 'setup'; // setup, lobby, playing, voting
let myRole = 'crewmate';
let myHat = 'none';
let gameMode = 'none'; // pvp2, pvp3, classic5

const CORES = ['#c51111', '#132ed1', '#117f2d', '#ed54ba', '#ef7d0d', '#f5f5f7', '#3947a1', '#71491e', '#13e1d1'];

function init(host) {
    isHost = host;
    const name = document.getElementById("nameIn").value;
    roomName = document.getElementById("roomIn").value;
    myId = isHost ? roomName : "p" + Math.floor(Math.random()*9999);
    
    players[myId] = {
        id: myId, name, x: 200, y: 200, color: CORES[Math.floor(Math.random()*CORES.length)],
        hat: 'none', role: 'crewmate', points: 0, alive: true, facing: 1, tasks: []
    };

    peer = new Peer(myId);
    peer.on('open', () => {
        if(!isHost) {
            setupConn(peer.connect(roomName));
        }
        showScreen('lobby');
        if(isHost) document.getElementById('host-controls').style.display = 'block';
    });
    peer.on('connection', setupConn);
    
    requestAnimationFrame(loop);
}

function setupConn(conn) {
    conn.on('open', () => {
        if(isHost) conns.push(conn);
        conn.send({ type: 'join', p: players[myId] });
    });
    conn.on('data', data => handleData(data, conn));
    conn.on('close', () => {
        if(!isHost) alert("Sala fechada pelo Host!");
        location.reload();
    });
}

function handleData(data, conn) {
    if(data.type === 'join') {
        players[data.p.id] = data.p;
        if(isHost) {
            broadcast({ type: 'sync', all: players });
            updateLobbyList();
        }
    }
    if(data.type === 'sync') {
        for(let id in data.all) if(id !== myId) players[id] = data.all[id];
        updateLobbyList();
    }
    if(data.type === 'kick') {
        if(myId === data.target) { alert("Voc√™ foi kickado!"); location.reload(); }
    }
    if(data.type === 'start_game') {
        gameMode = data.mode;
        startCountdown();
    }
    if(data.type === 'move') {
        if(players[data.id]) {
            players[data.id].x = data.x;
            players[data.id].y = data.y;
            players[data.id].facing = data.facing;
        }
    }
    if(data.type === 'kill_event') {
        players[data.target].alive = false;
        if(data.target === myId) alert("VOC√ä MORREU!");
    }
}

function broadcast(msg) {
    conns.forEach(c => c.open && c.send(msg));
}

function setHat(h) {
    myHat = h;
    players[myId].hat = h;
    if(isHost) broadcast({ type: 'sync', all: players });
    else if(conns[0]) conns[0].send({ type: 'join', p: players[myId] });
}

function updateLobbyList() {
    const list = document.getElementById('player-list');
    list.innerHTML = "";
    Object.values(players).forEach(p => {
        const div = document.createElement('div');
        div.innerHTML = `<span style="color:${p.color}">‚óè</span> ${p.name} ${p.id === myId ? '(Voc√™)' : ''}`;
        if(isHost && p.id !== myId) {
            const btn = document.createElement('button');
            btn.className = "btn-kick";
            btn.innerText = "KICK";
            btn.onclick = () => { broadcast({type:'kick', target: p.id}); delete players[p.id]; updateLobbyList(); };
            div.appendChild(btn);
        }
        list.appendChild(div);
    });
}

function startGame() {
    const count = Object.keys(players).length;
    let mode = 'classic5';
    if(count === 2) mode = 'pvp2';
    else if(count === 3) mode = 'pvp3';
    else if(count < 2) { alert("M√≠nimo 2 jogadores!"); return; }

    broadcast({ type: 'start_game', mode });
    gameMode = mode;
    startCountdown();
}

function startCountdown() {
    let timer = 3;
    const display = document.getElementById('countdown');
    const intv = setInterval(() => {
        display.innerText = timer;
        timer--;
        if(timer < 0) {
            clearInterval(intv);
            beginMatch();
        }
    }, 1000);
}

function beginMatch() {
    gameState = 'playing';
    showScreen('none');
    document.getElementById('game-ui').style.display = 'block';
    document.getElementById('controls').style.display = 'flex';
    document.getElementById('joystick').style.display = 'block';
    
    assignRoles();
    
    // Teleport inicial
    players[myId].x = 1000;
    players[myId].y = 1000;
}

function assignRoles() {
    const ids = Object.keys(players);
    if(gameMode === 'pvp2') {
        // Um impostor, um sherife
        const impIdx = Math.floor(Math.random()*2);
        players[ids[impIdx]].role = 'impostor';
        players[ids[1-impIdx]].role = 'sherife';
    } else if (gameMode === 'pvp3') {
        // Um imp, um sherife, um heroi
        let shuffled = ids.sort(() => 0.5 - Math.random());
        players[shuffled[0]].role = 'impostor';
        players[shuffled[1]].role = 'sherife';
        players[shuffled[2]].role = 'heroi';
    } else {
        // Classic
        let impId = ids[Math.floor(Math.random()*ids.length)];
        ids.forEach(id => players[id].role = (id === impId ? 'impostor' : 'crewmate'));
    }
    
    myRole = players[myId].role;
    document.getElementById('role-display').innerText = "ROLE: " + myRole.toUpperCase();
    document.getElementById('role-display').style.color = (myRole === 'impostor' ? 'red' : 'white');
    if(myRole === 'impostor' || myRole === 'sherife' || myRole === 'heroi') {
        document.getElementById('kill-btn').style.display = 'block';
    }
}

// --- DESENHO DO MAPA ---
function drawMap(ox, oy) {
    ctx.strokeStyle = "white";
    ctx.lineWidth = 10;
    
    // Nave Simples (The Skeld Estilo)
    ctx.strokeRect(800 - ox, 800 - oy, 800, 600); // Cafeteria
    ctx.strokeRect(1600 - ox, 950 - oy, 400, 300); // Admin
    ctx.strokeRect(400 - ox, 950 - oy, 400, 300); // Medbay
    
    // Corredores
    ctx.fillStyle = "#333";
    ctx.fillRect(800 - ox, 1050 - oy, 800, 100);
}

// --- DESENHO DO JOGADOR COM ACESS√ìRIOS ---
function drawPlayer(p, ox, oy) {
    if(!p.alive) {
        // Desenha ossinho/fantasma
        ctx.fillStyle = "rgba(255,255,255,0.3)";
        ctx.beginPath(); ctx.arc(p.x-ox, p.y-oy, 20, 0, Math.PI*2); ctx.fill();
        return;
    }

    const x = p.x - ox;
    const y = p.y - oy;
    
    ctx.save();
    ctx.translate(x, y);
    ctx.scale(p.facing, 1);
    
    // Corpo
    ctx.fillStyle = p.color;
    ctx.strokeStyle = "black";
    ctx.lineWidth = 3;
    ctx.beginPath(); ctx.roundRect(-20, -30, 40, 50, 10); ctx.fill(); ctx.stroke();
    // Visor
    ctx.fillStyle = "#add8e6";
    ctx.beginPath(); ctx.roundRect(5, -20, 25, 15, 5); ctx.fill(); ctx.stroke();
    
    // Acess√≥rios
    ctx.scale(1/p.facing, 1); // Desfaz flip para o chap√©u n√£o inverter
    ctx.font = "20px Arial";
    if(p.hat === 'banana') ctx.fillText("üçå", -10, -35);
    if(p.hat === 'pirate') ctx.fillText("üè¥‚Äç‚ò†Ô∏è", -10, -35);
    if(p.hat === 'phone') ctx.fillText("üì±", -10, -35);
    if(p.hat === 'headphone') ctx.fillText("üéß", -10, -35);
    if(p.hat === 'mask_covid') ctx.fillText("üò∑", -5, -10);

    ctx.restore();
    
    ctx.fillStyle = "white";
    ctx.textAlign = "center";
    ctx.fillText(p.name, x, y - 50);
}

// --- JOYSTICK E LOOP ---
let joy = { dx: 0, dy: 0 };
let isDrag = false;
const jEl = document.getElementById('joystick');
const sEl = document.getElementById('stick');

jEl.addEventListener('touchstart', e => { isDrag = true; });
window.addEventListener('touchmove', e => {
    if(!isDrag) return;
    const r = jEl.getBoundingClientRect();
    const touch = e.touches[0];
    let x = touch.clientX - r.left - 60;
    let y = touch.clientY - r.top - 60;
    const d = Math.min(Math.sqrt(x*x+y*y), 40);
    const a = Math.atan2(y,x);
    joy.dx = Math.cos(a) * (d/40);
    joy.dy = Math.sin(a) * (d/40);
    sEl.style.transform = `translate(${joy.dx*40}px, ${joy.dy*40}px)`;
});
window.addEventListener('touchend', () => { isDrag = false; joy={dx:0, dy:0}; sEl.style.transform = "none"; });

function loop() {
    requestAnimationFrame(loop);
    if(gameState === 'playing' && players[myId].alive) {
        players[myId].x += joy.dx * 5;
        players[myId].y += joy.dy * 5;
        if(joy.dx !== 0) players[myId].facing = joy.dx > 0 ? 1 : -1;
        
        broadcast({ type:'move', id: myId, x: players[myId].x, y: players[myId].y, facing: players[myId].facing });
    }

    ctx.fillStyle = "#000";
    ctx.fillRect(0,0,canvas.width, canvas.height);
    
    // Espa√ßo
    ctx.fillStyle = "white";
    for(let i=0; i<50; i++) ctx.fillRect((i*137)%canvas.width, (i*511)%canvas.height, 2, 2);

    if(gameState === 'playing' || gameState === 'voting') {
        const ox = players[myId].x - canvas.width/2;
        const oy = players[myId].y - canvas.height/2;
        
        drawMap(ox, oy);
        Object.values(players).forEach(p => drawPlayer(p, ox, oy));
    }
}

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
    if(id !== 'none') document.getElementById(id).style.display = 'flex';
}

function doAction(type) {
    if(type === 'kill') {
        Object.values(players).forEach(p => {
            if(p.id !== myId && p.alive) {
                const dist = Math.sqrt((p.x-players[myId].x)**2 + (p.y-players[myId].y)**2);
                if(dist < 60) {
                    broadcast({ type: 'kill_event', target: p.id });
                    players[p.id].alive = false;
                }
            }
        });
    }
}

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
</script>
</body>
</html>
loop();
</script>
</body>
</html>
