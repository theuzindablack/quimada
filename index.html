<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Among Us 2D - Fix Sincroniza√ß√£o</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --red: #ff3f34; --green: #05c46b; --blue: #1e90ff; }
        body, html { margin:0; padding:0; overflow:hidden; background:#000; font-family: sans-serif; color: white; touch-action: none; }
        canvas { display:block; }
        .screen { position:absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:100; background: #000; }
        #game-interface { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; }
        #ui-top { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); padding: 15px; border-radius: 8px; pointer-events: auto; border: 1px solid #444; }
        #lobby-menu { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; pointer-events: auto; border: 1px solid #444; }
        .cosmetic-btn { background: #333; border: 1px solid #555; color: white; padding: 10px; margin: 2px; cursor: pointer; font-size: 20px; width: 50px; }
        #joystick { position:absolute; bottom:40px; left:40px; width:120px; height:120px; background:rgba(255,255,255,0.1); border: 2px solid #fff; border-radius:50%; pointer-events: auto; }
        #stick { position:absolute; left:40px; top:40px; width:40px; height:40px; background:#fff; border-radius:50%; }
        #action-btns { position: absolute; bottom: 40px; right: 40px; pointer-events: auto; display:none; }
        .btn-main { width: 90px; height: 90px; border-radius: 50%; border: 4px solid white; font-weight: bold; color: white; cursor: pointer; font-size: 18px; }
        input { padding: 12px; margin: 10px; border-radius: 5px; background: #222; color: #fff; border: 1px solid #444; width: 200px; text-align: center; }
        button { padding: 10px 20px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { opacity: 0.8; }
    </style>
</head>
<body>

<div id="setup-screen" class="screen">
    <h1 style="color:var(--red); letter-spacing: 5px;">AMONG US 2D</h1>
    <input type="text" id="nameIn" placeholder="SEU NOME" value="Tripulante">
    <input type="text" id="roomIn" placeholder="ID DA SALA" value="SALA777">
    <div>
        <button onclick="init(true)" style="background:var(--green)">CRIAR SALA</button>
        <button onclick="init(false)" style="background:var(--blue)">ENTRAR</button>
    </div>
</div>

<div id="game-interface">
    <div id="ui-top">
        <div id="room-info" style="font-size: 12px; color: #aaa;">Sala: ---</div>
        <div id="player-count">Jogadores: 1</div>
        <div id="game-status" style="color: #0be881; font-weight: bold; margin-top:5px;">MODO: LOBBY</div>
        <div id="host-panel" style="display:none; margin-top: 10px;">
            <button onclick="startGame()" style="background:var(--red); width: 100%;">INICIAR PARTIDA</button>
        </div>
    </div>

    <div id="lobby-menu">
        <p style="font-size: 11px; text-align:center; color:#aaa;">CHAP√âUS</p>
        <button class="cosmetic-btn" onclick="setHat('none')">‚ùå</button>
        <button class="cosmetic-btn" onclick="setHat('üçå')">üçå</button>
        <button class="cosmetic-btn" onclick="setHat('üè¥‚Äç‚ò†Ô∏è')">üè¥‚Äç‚ò†Ô∏è</button>
        <button class="cosmetic-btn" onclick="setHat('üéß')">üéß</button>
        <button class="cosmetic-btn" onclick="setHat('üì±')">üì±</button>
        <button class="cosmetic-btn" onclick="setHat('üò∑')">üò∑</button>
    </div>

    <div id="joystick"><div id="stick"></div></div>

    <div id="action-btns">
        <button id="kill-btn" class="btn-main" style="background:var(--red);" onclick="killAction()">KILL</button>
    </div>
    
    <div id="countdown" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size: 100px; font-weight: bold; color: yellow; pointer-events: none; text-shadow: 4px 4px #000;"></div>
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
let peer, myId, roomName, isHost = false;
let players = {};
let conns = [];
let gameReady = false;

function init(host) {
    isHost = host;
    roomName = document.getElementById("roomIn").value;
    const myName = document.getElementById("nameIn").value;
    myId = isHost ? roomName : "p" + Math.floor(Math.random()*99999);

    players[myId] = {
        id: myId, name: myName, x: 1000, y: 1000, 
        color: ['#c51111', '#132ed1', '#117f2d', '#ed54ba', '#ef7d0d', '#f5f5f7'][Math.floor(Math.random()*6)],
        hat: 'none', alive: true, facing: 1, role: 'lobby'
    };

    peer = new Peer(myId);
    peer.on('open', (id) => {
        if(!isHost) setupConn(peer.connect(roomName));
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('game-interface').style.display = 'block';
        document.getElementById('room-info').innerText = "ID: " + id;
        if(isHost) document.getElementById('host-panel').style.display = 'block';
        gameReady = true;
    });
    peer.on('connection', setupConn);
    loop();
}

function setupConn(conn) {
    conn.on('open', () => {
        if(isHost) conns.push(conn);
        conn.send({ type: 'join', p: players[myId] });
    });
    conn.on('data', data => {
        if(data.type === 'join') {
            players[data.p.id] = data.p;
            if(isHost) broadcast({ type: 'sync', all: players });
        }
        if(data.type === 'sync') {
            // Sincroniza todos os jogadores, mas mant√©m a pr√≥pria posi√ß√£o
            for(let id in data.all) {
                if(id !== myId) players[id] = data.all[id];
            }
            updateUI();
        }
        if(data.type === 'move') {
            if(players[data.id]) {
                players[data.id].x = data.x;
                players[data.id].y = data.y;
                players[data.id].facing = data.facing;
            }
        }
        if(data.type === 'start_event') {
            applyStartEffect(data.role);
        }
    });
}

function broadcast(msg) {
    conns.forEach(c => c.open && c.send(msg));
}

function updateUI() {
    document.getElementById('player-count').innerText = "Jogadores: " + Object.keys(players).length;
}

function setHat(hat) {
    players[myId].hat = hat;
    const msg = { type: 'join', p: players[myId] };
    if(isHost) broadcast({ type: 'sync', all: players });
    else if(conns[0]) conns[0].send(msg);
}

function startGame() {
    const ids = Object.keys(players);
    if(ids.length < 2) return alert("Precisa de pelo menos 2 jogadores!");
    
    let shuffled = [...ids].sort(() => Math.random() - 0.5);
    let roles = {};
    
    // Define pap√©is
    roles[shuffled[0]] = 'impostor';
    if(ids.length === 2) roles[shuffled[1]] = 'sherife';
    else ids.forEach(id => { if(!roles[id]) roles[id] = 'tripulante'; });

    // Envia para todos
    ids.forEach(id => {
        const data = { type: 'start_event', role: roles[id] };
        if(id === myId) applyStartEffect(roles[id]);
        else {
            const c = conns.find(conn => conn.peer === id);
            if(c) c.send(data);
        }
    });
}

function applyStartEffect(role) {
    let count = 3;
    const cd = document.getElementById('countdown');
    const timer = setInterval(() => {
        cd.innerText = count;
        count--;
        if(count < 0) {
            clearInterval(timer);
            cd.innerText = "";
            players[myId].role = role;
            document.getElementById('game-status').innerText = "ROLE: " + role.toUpperCase();
            document.getElementById('game-status').style.color = (role === 'impostor' ? 'red' : 'white');
            document.getElementById('lobby-menu').style.display = 'none';
            if(role === 'impostor' || role === 'sherife') {
                document.getElementById('action-btns').style.display = 'block';
            }
        }
    }, 1000);
}

// --- RENDERIZA√á√ÉO ---
function drawPlayer(p, ox, oy) {
    const x = p.x - ox;
    const y = p.y - oy;
    ctx.save();
    ctx.translate(x, y);
    ctx.scale(p.facing, 1);
    
    // Corpo
    ctx.fillStyle = p.color;
    ctx.strokeStyle = "black";
    ctx.lineWidth = 3;
    ctx.beginPath(); ctx.roundRect(-20, -30, 40, 50, 10); ctx.fill(); ctx.stroke();
    // Visor
    ctx.fillStyle = "#add8e6";
    ctx.beginPath(); ctx.roundRect(5, -20, 25, 15, 5); ctx.fill(); ctx.stroke();
    
    // Chap√©u
    if(p.hat !== 'none') {
        ctx.scale(1/p.facing, 1);
        ctx.font = "24px Arial";
        ctx.textAlign = "center";
        ctx.fillText(p.hat, 0, -35);
    }
    ctx.restore();
    
    ctx.fillStyle = "white";
    ctx.font = "bold 14px sans-serif";
    ctx.textAlign = "center";
    ctx.fillText(p.name, x, y - 55);
}

function drawMap(ox, oy) {
    ctx.strokeStyle = "#444";
    ctx.lineWidth = 10;
    // Cafeteria
    ctx.strokeRect(700-ox, 700-oy, 600, 600);
    // Mesa
    ctx.fillStyle = "#222";
    ctx.beginPath(); ctx.arc(1000-ox, 1000-oy, 80, 0, Math.PI*2); ctx.fill(); ctx.stroke();
}

let joy = { dx: 0, dy: 0 };
const joyEl = document.getElementById('joystick');
const stickEl = document.getElementById('stick');

joyEl.addEventListener('touchmove', e => {
    e.preventDefault();
    const r = joyEl.getBoundingClientRect();
    const t = e.touches[0];
    let x = t.clientX - r.left - 60;
    let y = t.clientY - r.top - 60;
    const d = Math.min(Math.sqrt(x*x+y*y), 45);
    const a = Math.atan2(y, x);
    joy.dx = Math.cos(a) * (d/45);
    joy.dy = Math.sin(a) * (d/45);
    stickEl.style.transform = `translate(${joy.dx*45}px, ${joy.dy*45}px)`;
});
joyEl.addEventListener('touchend', () => { joy = {dx:0, dy:0}; stickEl.style.transform = "none"; });

function loop() {
    requestAnimationFrame(loop);
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    if(gameReady && players[myId]) {
        if(joy.dx !== 0 || joy.dy !== 0) {
            players[myId].x += joy.dx * 6;
            players[myId].y += joy.dy * 6;
            players[myId].facing = joy.dx > 0 ? 1 : -1;
            
            const moveData = { type:'move', id: myId, x: players[myId].x, y: players[myId].y, facing: players[myId].facing };
            if(isHost) broadcast(moveData);
            else if(conns[0]) conns[0].send(moveData);
        }
    }

    ctx.fillStyle = "#111";
    ctx.fillRect(0,0,canvas.width, canvas.height);
    
    if(players[myId]) {
        const ox = players[myId].x - canvas.width/2;
        const oy = players[myId].y - canvas.height/2;
        drawMap(ox, oy);
        for(let id in players) drawPlayer(players[id], ox, oy);
    }
}
</script>
</body>
</html>


// --- DESENHO DO JOGADOR COM ACESS√ìRIOS ---
function drawPlayer(p, ox, oy) {
    if(!p.alive) {
        // Desenha ossinho/fantasma
        ctx.fillStyle = "rgba(255,255,255,0.3)";
        ctx.beginPath(); ctx.arc(p.x-ox, p.y-oy, 20, 0, Math.PI*2); ctx.fill();
        return;
    }

    const x = p.x - ox;
    const y = p.y - oy;
    
    ctx.save();
    ctx.translate(x, y);
    ctx.scale(p.facing, 1);
    
    // Corpo
    ctx.fillStyle = p.color;
    ctx.strokeStyle = "black";
    ctx.lineWidth = 3;
    ctx.beginPath(); ctx.roundRect(-20, -30, 40, 50, 10); ctx.fill(); ctx.stroke();
    // Visor
    ctx.fillStyle = "#add8e6";
    ctx.beginPath(); ctx.roundRect(5, -20, 25, 15, 5); ctx.fill(); ctx.stroke();
    
    // Acess√≥rios
    ctx.scale(1/p.facing, 1); // Desfaz flip para o chap√©u n√£o inverter
    ctx.font = "20px Arial";
    if(p.hat === 'banana') ctx.fillText("üçå", -10, -35);
    if(p.hat === 'pirate') ctx.fillText("üè¥‚Äç‚ò†Ô∏è", -10, -35);
    if(p.hat === 'phone') ctx.fillText("üì±", -10, -35);
    if(p.hat === 'headphone') ctx.fillText("üéß", -10, -35);
    if(p.hat === 'mask_covid') ctx.fillText("üò∑", -5, -10);

    ctx.restore();
    
    ctx.fillStyle = "white";
    ctx.textAlign = "center";
    ctx.fillText(p.name, x, y - 50);
}

// --- JOYSTICK E LOOP ---
let joy = { dx: 0, dy: 0 };
let isDrag = false;
const jEl = document.getElementById('joystick');
const sEl = document.getElementById('stick');

jEl.addEventListener('touchstart', e => { isDrag = true; });
window.addEventListener('touchmove', e => {
    if(!isDrag) return;
    const r = jEl.getBoundingClientRect();
    const touch = e.touches[0];
    let x = touch.clientX - r.left - 60;
    let y = touch.clientY - r.top - 60;
    const d = Math.min(Math.sqrt(x*x+y*y), 40);
    const a = Math.atan2(y,x);
    joy.dx = Math.cos(a) * (d/40);
    joy.dy = Math.sin(a) * (d/40);
    sEl.style.transform = `translate(${joy.dx*40}px, ${joy.dy*40}px)`;
});
window.addEventListener('touchend', () => { isDrag = false; joy={dx:0, dy:0}; sEl.style.transform = "none"; });

function loop() {
    requestAnimationFrame(loop);
    if(gameState === 'playing' && players[myId].alive) {
        players[myId].x += joy.dx * 5;
        players[myId].y += joy.dy * 5;
        if(joy.dx !== 0) players[myId].facing = joy.dx > 0 ? 1 : -1;
        
        broadcast({ type:'move', id: myId, x: players[myId].x, y: players[myId].y, facing: players[myId].facing });
    }

    ctx.fillStyle = "#000";
    ctx.fillRect(0,0,canvas.width, canvas.height);
    
    // Espa√ßo
    ctx.fillStyle = "white";
    for(let i=0; i<50; i++) ctx.fillRect((i*137)%canvas.width, (i*511)%canvas.height, 2, 2);

    if(gameState === 'playing' || gameState === 'voting') {
        const ox = players[myId].x - canvas.width/2;
        const oy = players[myId].y - canvas.height/2;
        
        drawMap(ox, oy);
        Object.values(players).forEach(p => drawPlayer(p, ox, oy));
    }
}

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
    if(id !== 'none') document.getElementById(id).style.display = 'flex';
}

function doAction(type) {
    if(type === 'kill') {
        Object.values(players).forEach(p => {
            if(p.id !== myId && p.alive) {
                const dist = Math.sqrt((p.x-players[myId].x)**2 + (p.y-players[myId].y)**2);
                if(dist < 60) {
                    broadcast({ type: 'kill_event', target: p.id });
                    players[p.id].alive = false;
                }
            }
        });
    }
}

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
</script>
</body>
</html>
loop();
</script>
</body>
</html>
